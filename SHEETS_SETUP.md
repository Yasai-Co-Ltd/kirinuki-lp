# Google Sheets連携セットアップガイド

このガイドでは、注文データをGoogle Sheetsに自動保存するための設定方法を説明します。

## 1. Google Cloud Projectの作成

1. [Google Cloud Console](https://console.cloud.google.com/)にアクセス
2. 新しいプロジェクトを作成するか、既存のプロジェクトを選択
3. プロジェクト名を設定（例：`kirinuki-sheets-integration`）

## 2. Google Sheets APIの有効化

1. Google Cloud Consoleで「APIとサービス」→「ライブラリ」に移動
2. "Google Sheets API"を検索
3. Google Sheets APIを選択し、「有効にする」をクリック

## 3. サービスアカウントの作成

1. 「APIとサービス」→「認証情報」に移動
2. 「認証情報を作成」→「サービスアカウント」を選択
3. サービスアカウント情報を入力：
   - サービスアカウント名：`kirinuki-sheets-service`
   - サービスアカウントID：自動生成される
   - 説明：`切り抜き注文データをGoogle Sheetsに保存するためのサービスアカウント`
4. 「作成して続行」をクリック
5. ロールは設定せずに「続行」をクリック
6. 「完了」をクリック

## 4. サービスアカウントキーの作成

1. 作成したサービスアカウントをクリック
2. 「キー」タブに移動
3. 「鍵を追加」→「新しい鍵を作成」をクリック
4. キーのタイプで「JSON」を選択
5. 「作成」をクリック
6. JSONファイルがダウンロードされます（安全に保管してください）

## 5. Google Sheetsスプレッドシートの作成

1. [Google Sheets](https://sheets.google.com/)で新しいスプレッドシートを作成
2. スプレッドシート名を設定（例：`切り抜き注文管理`）
3. URLからスプレッドシートIDを取得：
   ```
   https://docs.google.com/spreadsheets/d/[SPREADSHEET_ID]/edit
   ```
4. サービスアカウントにスプレッドシートの編集権限を付与：
   - スプレッドシートの「共有」ボタンをクリック
   - サービスアカウントのメールアドレス（JSONファイル内の`client_email`）を追加
   - 権限を「編集者」に設定

## 6. 環境変数の設定

プロジェクトの`.env.local`ファイルに以下の環境変数を追加：

```env
# Google Sheets設定
GOOGLE_SHEETS_SPREADSHEET_ID=your_spreadsheet_id_here
GOOGLE_SHEETS_CLIENT_EMAIL=your_service_account_email_here
GOOGLE_SHEETS_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\nyour_private_key_here\n-----END PRIVATE KEY-----"
```

### 設定値の取得方法：

- **GOOGLE_SHEETS_SPREADSHEET_ID**: スプレッドシートのURLから取得
- **GOOGLE_SHEETS_CLIENT_EMAIL**: JSONファイルの`client_email`の値
- **GOOGLE_SHEETS_PRIVATE_KEY**: JSONファイルの`private_key`の値（改行文字`\n`を含む）

### 注意事項：

- `GOOGLE_SHEETS_PRIVATE_KEY`は必ずダブルクォートで囲んでください
- 改行文字`\n`はそのまま含めてください
- JSONファイルは安全な場所に保管し、Gitにコミットしないでください

## 7. 動作確認

1. アプリケーションを起動
2. 管理者パネル（右下の歯車アイコン）を開く
3. "Google Sheets設定"セクションで設定状況を確認
4. 設定が正常な場合、「スプレッドシートを初期化」ボタンが表示されます
5. ボタンをクリックしてヘッダー行を初期化

## 8. スプレッドシートの構造

初期化後、スプレッドシートには以下のヘッダー行が作成されます：

| 列 | ヘッダー | 説明 |
|---|---|---|
| A | 注文日時 | 注文が完了した日時 |
| B | 決済ID | Stripeの決済ID |
| C | 顧客名 | 注文者の名前 |
| D | メールアドレス | 注文者のメールアドレス |
| E | 動画数 | 注文した動画の本数 |
| F | 動画タイトル | 動画のタイトル（複数の場合は\|で区切り） |
| G | チャンネル名 | YouTubeチャンネル名 |
| H | 動画時間 | 動画の長さ |
| I | 動画URL | YouTubeのURL |
| J | フォーマット | 切り抜きフォーマット |
| K | 品質オプション | AIのみ/人の目で確認 |
| L | 優先クリップ長 | 希望するクリップの長さ |
| M | アスペクト比 | 動画のアスペクト比 |
| N | 字幕 | 字幕の有無 |
| O | タイトル | タイトルの有無 |
| P | 特別な要望 | 顧客からの特別な要望 |
| Q | 金額 | 注文金額 |
| R | 納期 | 予定納期 |
| S | ステータス | 制作ステータス（初期値：未着手） |

## 9. トラブルシューティング

### 「Google Sheets設定が未設定」と表示される場合

1. 環境変数が正しく設定されているか確認
2. アプリケーションを再起動
3. `.env.local`ファイルがプロジェクトルートにあるか確認

### 「スプレッドシートへの保存に失敗しました」エラーが発生する場合

1. サービスアカウントにスプレッドシートの編集権限があるか確認
2. スプレッドシートIDが正しいか確認
3. Google Sheets APIが有効になっているか確認
4. サービスアカウントキーが正しく設定されているか確認

### 権限エラーが発生する場合

1. サービスアカウントのメールアドレスをスプレッドシートに共有
2. 権限を「編集者」に設定
3. Google Sheets APIが有効になっているか確認

## 10. セキュリティ注意事項

- サービスアカウントのJSONファイルは機密情報です
- `.env.local`ファイルをGitにコミットしないでください
- 本番環境では適切な環境変数管理システムを使用してください
- 定期的にサービスアカウントキーをローテーションしてください

## 11. 運用について

- スプレッドシートは手動で編集可能です
- ステータス列を使用して制作進捗を管理できます
- 必要に応じて列を追加してカスタマイズ可能です
- データのバックアップを定期的に取ることを推奨します